#pragma once

#include <kernel/gen_config.h>

#include <nt.h>
#include <assert.h>
#include <compile_assert.h>
#include <string.h>
#include <gnu.h>
#include <debug.h>
#include <image.h>
#include <util.h>
#include <services.h>

#include "ke.h"
#include "mm.h"
#include "ex.h"
#include "ob.h"
#include "io.h"
#include "cm.h"
#include "ps.h"
#include "ldr.h"
#include "rtl.h"
#include "hal.h"

/* Generated by syssvc-gen.py */
#include <ntos_syssvc_gen.h>
#include <ntos_wdmsvc_gen.h>

#define UNIMPLEMENTED_ROUTINE				\
    DbgTrace("Routine is unimplemented\n");		\
    HalVgaPrint("%s UNIMPLEMENTED\n", __func__);

#define UNIMPLEMENTED					\
    {							\
	COMPILE_CHECK_ASYNC_RETURN;			\
	UNIMPLEMENTED_ROUTINE;				\
	return STATUS_NOT_IMPLEMENTED;			\
    }

#define UNIMPLEMENTED_ASYNC(State)			\
    {							\
	COMPILE_CHECK_ASYNC_FRAME_SIZE;			\
	UNIMPLEMENTED_ROUTINE;				\
	ASYNC_RETURN(State, STATUS_NOT_IMPLEMENTED);	\
    }

#if defined(CONFIG_DEBUG_BUILD)
VOID vDbgPrint(PCSTR Format, va_list args);
#endif

#define assert_ret(expr)	if (!(expr)) { return STATUS_NTOS_BUG; }

/*
 * Debug helper functions
 */
#ifdef CONFIG_DEBUG_BUILD
VOID MmDbgDumpCapTreeNode(IN PCAP_TREE_NODE Node);
VOID MmDbgDumpCNode(IN PCNODE CNode);
VOID MmDbgDumpUntypedInfo();
VOID MmDbgDumpPagingStructure(IN PPAGING_STRUCTURE Paging);
VOID MmDbgDumpPagingStructureRecursively(IN PPAGING_STRUCTURE Paging);
VOID MmDbgDumpSection(IN PSECTION Section);
VOID MmDbgDumpVad(PMMVAD Vad);
VOID MmDbgDumpVSpace(PVIRT_ADDR_SPACE VSpace);
VOID IoDbgDumpFileObject(IN PIO_FILE_OBJECT File);
#else
#define MmDbgDumpCapTreeNode(x)
#define MmDbgDumpCNode(x)
#define MmDbgDumpUntypedInfo()
#define MmDbgDumpPagingStructure(x)
#define MmDbgDumpPagingStructureRecursively(x)
#define MmDbgDumpSection(x)
#define MmDbgDumpVad(x)
#define MmDbgDumpVSpace(x)
#define IoDbgDumpFileObject(x)
#endif

/*
 * Additional alignment macros
 */
#define IS_ALIGNED_BY(addr, align)	((ULONG_PTR)(addr) == ALIGN_DOWN_BY(addr, align))
#define IS_ALIGNED(addr, type)		((ULONG_PTR)(addr) == ALIGN_DOWN(addr, type))
